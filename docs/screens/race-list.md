# レース一覧ページ 仕様

## 概要
- 中央・地方競馬のレースを横断的に検索し、予測対象レースを選択するための一覧画面。
- 日付・開催場・条件でフィルタリングし、詳細や予測ページへの導線を提供する。

## ペルソナとユースケース
- 一般ユーザー：当日のレースを素早く絞り込み、予測を実行したいレースを選択。
- 上級ユーザー：特定条件（芝/ダート、距離、クラス）で過去レースも検索し、履歴分析を行う。
- 管理者：データ欠損や更新遅延がないか一覧で確認。

## 前提・依存
- API：`GET /api/races`（ページネーション、開催日・場フィルタ、距離/馬場条件）、`GET /api/races/{race_id}`（詳細表示用）。
- データ更新ジョブ（計画17）が毎日データを最新化。
- 予測済みフラグや注目ラベルはバックエンドで提供可能か要確認。

## UI構成
- フィルタセクション：開催日（カレンダー）、開催場（チェックボックス）、クラス/距離/馬場状態（ドロップダウン）。
- 検索結果テーブル：レース名、開催日時、距離、馬場、出走頭数、予測ステータス。
- ページネーション：ページサイズ選択、前後ナビゲーション。
- サイドバー：お気に入りレース、閲覧履歴、モデルからの推奨タグ。
- 詳細プレビュー（オプション）：レース行ホバーまたはクリックでサイドパネルに詳細を表示。

## データ要件
- レース一覧APIはISO8601日時と会場コードを返却。
- フィルタ入力はクエリパラメータに変換（例：`?date=2025-11-08&venue=tokyo&surface=turf`）。
- ページネーションは`page`と`page_size`で制御、最大100件/ページ。
- ソートは開催日時昇順をデフォルトとし、ユーザー操作で距離や賞金額などに切替可能。

## 状態と遷移
- 初期表示：当日開催の中央競馬をデフォルトフィルタとして表示。
- フィルタ変更：操作から300msのディバウンス後にAPIを再リクエスト。
- データ取得中：テーブル・サイドバーにスケルトン表示。
- 空データ：該当レースなしメッセージとフィルタリセットボタン。
- エラー：通信失敗時に再試行ボタンとサポート案内を表示。

## インタラクション
- レース行クリックで`/races/{race_id}`詳細ページまたはモーダルを開く。
- 「予測する」ボタンで予測ページ（レースID付き）へ遷移。
- お気に入りアイコンでレースを保存し、設定ページで管理可能にする。
- テーブルヘッダークリックでソート、複数条件ソートは現状未対応。

## バリデーション・エラーハンドリング
- フィルタ入力は日付範囲（過去3年〜翌週）と文字列形式をチェック。
- 連続APIリクエストのレート制限（429）時は待機案内を表示。
- 取得データに必須フィールド欠損がある場合はログ報告し、該当行を非表示。

## 計測・ログ
- `race_list_viewed`イベントでフィルタパラメータを含め計測。
- お気に入り登録数、予測ページ遷移数をトラッキング。
- APIエラーはSentryにレースIDとフィルタ条件を添えて送信。

## アクセシビリティ
- テーブルは`<table>`構造とキャプションを使用し、スクリーンリーダー向けに各ヘッダーを定義。
- フィルタフォームは`fieldset`と`legend`でグルーピングし、キーボード操作で完結可能にする。
- ハイライトやタグの色分けはアイコン/テキスト併用で表現。

## テスト観点
- 単体：フィルタ入力→クエリ変換ロジック、ページネーション計算、スケルトン表示。
- 統合：APIモックを用いたフィルタ組合せ、エラー時の再試行。
- E2E：フィルタ変更→結果確認→予測ページ遷移のシナリオ、お気に入り登録の永続化確認。

## 未決定事項・メモ
- 過去レースの閲覧期間制限とアーカイブ扱い。
- 推奨タグの判定（機械学習モデル vs 手動設定）。
- 分析用にCSVエクスポート機能を追加するかは別途検討。

