# 予測履歴ページ 仕様

## 概要
- ユーザーごとの予測履歴を時系列で閲覧し、成果を振り返る画面。
- 過去3年間の履歴を保存し、フィルタや検索で目的のレースを探せるようにする。

## ペルソナとユースケース
- 一般ユーザー：直近の結果を振り返り、的中状況と回収率を確認。
- 上級ユーザー：条件別（場・距離・天候）の予測傾向を分析。
- 管理者：ユーザーサポートや不正検知のために履歴を参照。

## 前提・依存
- API：`GET /api/predictions`（ページネーション、期間・レース条件フィルタ）、`GET /api/predictions/{id}`。
- 予測履歴テーブルは計画08で実装済みで、3年間保存される。
- 的中結果はレース結果更新（計画10/17）完了後に連携される。

## UI構成
- フィルタ：期間（カレンダー/プリセット）、開催場、レース種別、的中有無。
- 結果一覧：カードまたはテーブル形式で予測日時、レース情報、上位馬、的中状況、回収率を表示。
- サマリヘッダー：期間内の的中数、回収率平均、予測回数。
- 詳細パネル：選択した履歴の予測詳細、根拠、実績結果を表示。
- エクスポートボタン：CSV保存（オプション）。

## データ要件
- APIレスポンス：`items[]`（`predictionId`、`race`情報、`predictedTop3`、`probabilities`、`result`、`payout`、`createdAt`）。
- ページネーション：無限スクロールまたはページナビ、サーバレスポンスに`totalCount`。
- 的中状況は`hit`（boolean）、`hitType`（単勝/複勝/ワイドなど）を含めると拡張しやすい。

## 状態と遷移
- 初期：最近30日分を自動取得。
- フィルタ変更：ローディングスケルトン表示、結果件数0時はメッセージ表示。
- 詳細表示：行選択で右サイドに詳細情報を表示、別ページ遷移も可。
- データ量が多い場合は仮想スクロールでパフォーマンスを確保。

## インタラクション
- 履歴行クリックで予測ページまたはモーダルを開き、より詳細なグラフを閲覧。
- エクスポート実行でバックエンドにリクエスト、完了後ファイルダウンロード。
- サマリカードをクリックすると該当フィルタが適用される（例：的中数カード→`hit=true`）。

## バリデーション・エラーハンドリング
- 期間フィルタの開始>終了は即時エラー表示。
- API 401/403はセッション切れとしてログインページへリダイレクト。
- データ取得失敗はリトライ、連続失敗時はサポート連絡導線。

## 計測・ログ
- `prediction_history_viewed`イベントでフィルタ条件を記録。
- エクスポート実行、詳細表示回数を計測。
- API失敗や変換失敗はSentryへ送信し、predictionIdを含める。

## アクセシビリティ
- テーブル/カードはいずれもキーボード操作で選択可能にする。
- 詳細パネルは`dialog`ロールを使用し、フォーカストラップを適切に制御。
- データ量が多い場合でもスクリーンリーダーが読めるよう、ページネーションラベルを明確にする。

## テスト観点
- 単体：フィルタ条件のクエリ変換、サマリ計算、ページネーション状態管理。
- 統合：APIモックでヒット/未ヒット混在、期間外データの除外。
- E2E：期間フィルタ→結果確認→詳細閲覧→エクスポートまでの一連操作。

## 未決定事項・メモ
- CSV出力の列項目とマスク方針（個人情報が含まれる場合）。
- データ保持期間超過時のアーカイブ表示（削除するか注釈表示か）。
- 予測比較ページとの連携（履歴から直接比較タブを開くか）。

