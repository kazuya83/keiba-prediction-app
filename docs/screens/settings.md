# 設定ページ 仕様

## 概要
- ユーザーがプロフィール、アカウント設定、通知設定、セキュリティ設定を管理する画面。
- 認証済みユーザー向けであり、重要情報は再認証や二段階認証を考慮する。

## ペルソナとユースケース
- 一般ユーザー：プロフィール更新、通知カテゴリの調整、パスワード変更。
- 上級ユーザー：レースお気に入り設定、データエクスポート、APIトークン管理（将来的に）。
- 管理者：ユーザー自身の設定に加え、管理者専用メニューへの導線。

## 前提・依存
- API：`GET/PUT /api/users/me`（プロフィール）、`POST /api/auth/logout`、`POST /api/auth/token/refresh`、`POST /api/notifications/settings`。
- パスワード変更や二段階認証は追加APIが必要（未実装の場合は未定義セクションとして扱う）。
- ソーシャルログインユーザーのパスワード設定フローは別途定義。

## UI構成
- サイドナビ：プロフィール、セキュリティ、通知、接続サービス（ソーシャル連携）、データ管理タブ。
- プロフィールフォーム：表示名、アイコン画像、自己紹介、地域、言語設定。
- セキュリティ：パスワード変更フォーム、2FA設定（未定義時はComing Soon表示）、ログイン履歴。
- 通知設定：カテゴリ別トグル、Quiet Hours設定、ブラウザプッシュ許可状態表示。
- 接続サービス：リンク済みソーシャルアカウント一覧、解除ボタン。
- データ管理：予測履歴エクスポート、アカウント削除/退会手続き。

## データ要件
- プロフィール：`displayName`、`avatarUrl`、`bio`、`favoriteTracks`、`language`。
- 通知設定：`enableEmail`（将来）、`enableApp`、`enablePush`、`quietHours`（開始/終了）、`raceFilters[]`。
- セキュリティ：パスワード変更時に現在のパスワード・新パスワード・確認パスワードを要求。
- ソーシャル連携：`provider`、`linkedAt`、`status`。

## 状態と遷移
- 初期：`GET /api/users/me`と通知設定を並列取得、ローディングスケルトン表示。
- 更新成功：フォームをロック解除し、トーストで成功メッセージ、必要に応じてストア更新。
- 更新失敗：エラー内容に応じてフィールドエラーまたは一般エラー表示。
- パスワード変更成功後は再ログインを促す（トークンリフレッシュ無効化の可能性）。

## インタラクション
- アバター変更はクラウドストレージへのアップロード、進行状況をプログレスバーで表示。
- 通知カテゴリトグルは即時保存またはバッチ保存（「保存」ボタン）を選択、UX検討。
- 2FA設定はモーダルでQRコード表示、OTP確認を実施（実装時）。
- アカウント削除ボタンは2段階確認ダイアログと再認証を要求。

## バリデーション・エラーハンドリング
- プロフィール：表示名は1〜50文字、自己紹介は500文字程度の制限。
- パスワード：強度チェックと一致確認、APIエラー時の詳細（旧パスワード不一致）を表示。
- アバター：画像サイズ/形式チェック、アップロード失敗時の再試行案内。
- 設定更新頻度制限がある場合、429時の待機メッセージを提示。

## 計測・ログ
- `settings_viewed`イベント、セクション切替や保存操作を計測。
- セキュリティ関連操作は監査ログに記録（API側で実施）。
- アカウント削除リクエストはバックエンドへ重要イベントとして通知。

## アクセシビリティ
- フォームコントロールは`label`と`aria`属性を適切に設定。
- セクション間のキーボードナビゲーションとフォーカス管理を徹底。
- エラー文言は色だけでなくアイコンとテキストで伝達。

## テスト観点
- 単体：フォーム状態管理、バリデーション、画像アップロードモック。
- 統合：APIモックで更新成功/失敗、ソーシャル解除のサイドエフェクト。
- E2E：プロフィール更新→通知設定変更→パスワード変更→ログアウトまでの一連操作。

## 未決定事項・メモ
- 2FA導入タイミングとUI仕様。
- アカウント削除の猶予期間やデータ匿名化ポリシー。
- ソーシャルログインユーザーがパスワードを設定できるかのルール。

