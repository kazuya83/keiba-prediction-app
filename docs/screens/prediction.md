# 予測ページ 仕様

## 概要
- 選択したレースに対して機械学習モデルで予測を実行し、結果と根拠を提示する中核画面。
- 表形式とグラフ形式の両表示を提供し、ユーザーが意思決定を行いやすい構成とする。

## ペルソナとユースケース
- 一般ユーザー：レース直前に上位3頭と確率を確認し、馬券購入判断に活用。
- 上級ユーザー：予測根拠（特徴量重要度やSHAP値）を参照し、モデルの信頼度を評価。
- 管理者：異常な結果やモデルエラーの検知。

## 前提・依存
- API：`POST /api/predictions`（推論リクエスト）、`GET /api/predictions/{prediction_id}`（詳細取得）、`GET /api/predictions/{prediction_id}/compare`（過去予測比較）。
- 推論ジョブは最大1分で完了し、プログレス表示のためにポーリングもしくはWebSocketを使用。
- Featureサービスからの必要データ（天候、馬場状態、過去成績）が揃っていること。

## UI構成
- レース情報ヘッダー：レース名、開催日時、条件、天候・馬場状態。
- アクションバー：予測実行ボタン、設定（モデル選択/特徴量セット）、共有ボタン。
- 結果タブ：
  - 表形式：順位、馬名、確率、オッズ、推奨指標。
  - グラフ：確率棒グラフ、勝率推移チャート。
- 根拠タブ：特徴量重要度リスト、SHAP値可視化、コメント欄（説明テキスト）。
- 比較タブ：過去予測との差分、実際の結果との比較、的中状況。

## データ要件
- リクエストペイロード：`raceId`、`modelId`（任意）、`featureSetId`（任意）。
- レスポンス：`predictionId`、`status`（`pending`/`running`/`completed`/`failed`）、`rankings[]`（馬ID、名前、確率、信頼区間）、`explanations`（特徴量ID、寄与度）、`metadata`（モデルバージョン、推論時間）。
- 比較データ：直近N回の予測、実着順、回収率。

## 状態と遷移
- 初期：レース選択直後は過去予測の表示、最新予測がなければ「予測を実行」CTAを強調。
- 推論中：プログレスバーと残り時間目安を表示、キャンセルボタンを提供（バックエンド対応時）。
- 完了：表とグラフをレンダリング、共有リンク生成。
- 失敗：失敗理由メッセージ（入力不足/モデル障害/タイムアウト）と再実行ボタン。
- 比較表示：タブ切替でAPIを追加取得し、差分テーブルまたはチャート表示。

## インタラクション
- モデル切替：複数モデルが用意される場合、ドロップダウンで再予測を実施。
- 特徴量セット切替：詳細ユーザー向けに軽量/フル特徴量を選択、再予測時に反映。
- 共有：URLコピー、将来的にSNS共有ボタンを検討。
- グラフツールチップ：確率と補足情報を表示。

## バリデーション・エラーハンドリング
- レース未選択や推論対象レースの受付終了時は予測をブロックし、理由を表示。
- 同一レース・同一モデルの連続リクエストを短時間に送らないためのクールダウン表示。
- バックエンドから400/422エラーが返った場合は入力不備としてフォームエリアにハイライト。
- 500系エラーはサポート案内とテレメトリ送信。

## 計測・ログ
- `prediction_run_requested`、`prediction_run_completed`、`prediction_share_clicked`など主要イベントを記録。
- 推論時間、モデルバージョン、成功/失敗率をダッシュボード向けに収集。
- 致命的エラーはSentryへスタックトレース付きで送信。

## アクセシビリティ
- 結果テーブルはソート可能列にキーボードイベントを対応させる。
- グラフにはデータテーブルの代替表現と`aria`属性を付与。
- 色のみで順位を表現しない（番号やテキスト併用）。

## テスト観点
- 単体：状態管理、ポーリング制御、レスポンス整形、グラフ描画。
- 統合：APIモックで正常/タイムアウト/失敗、モデル切替時の再リクエスト。
- E2E：レース選択→予測実行→結果閲覧→比較タブへの遷移を確認。

## 未決定事項・メモ
- プログレス更新のための通信方式（ポーリング/Server-Sent Events/WebSocket）。
- 共有機能で外部公開URLを許可するか、ログイン必須とするか。
- 特徴量説明の文言整備や翻訳方針。

