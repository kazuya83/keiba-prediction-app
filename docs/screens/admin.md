# 管理者ページ 仕様

## 概要
- 管理者がユーザー管理、データ監視、モデル運用タスクを実行するための管理コンソール。
- 主要機能：ユーザー一覧/制御、エラーログ閲覧、モデル再学習トリガ、監査ログ閲覧。

## ペルソナとユースケース
- 運用担当者：ユーザー凍結や権限変更、サポート対応。
- データエンジニア：スクレイピング・バッチジョブの監視と再実行。
- MLエンジニア：モデル再学習を手動実行し、結果を確認。

## 前提・依存
- API：`GET /api/admin/users`、`PATCH /api/admin/users/{id}`（ロール更新/凍結）、`GET /api/admin/errors`、`POST /api/admin/model/train`、`GET /api/admin/audit-logs`。
- 認証：管理者ロールを`get_current_admin`で確認（計画11）。
- バックグラウンドジョブ基盤（Celery/RQ等）が稼働し、モデル再学習APIがキュー投入できる。

## UI構成
- サイドナビ：ユーザー管理、ジョブ監視、モデル運用、監査ログ。
- ユーザー管理テーブル：検索（メール/名前）、ロール、ステータス、最終ログイン、操作ボタン（凍結/解除、権限変更）。
- ユーザー詳細モーダル：プロフィール情報、最近の予測履歴リンク、監査ログ抜粋。
- ジョブ監視：最新バッチ結果一覧、成功/失敗ステータス、手動再実行ボタン、スケジューラ状態。
- モデル運用：最新モデル一覧、評価指標、再学習ボタン、進行状況表示。
- 監査ログ：フィルタ（期間、ユーザー、アクション種別）、テーブル表示、エクスポート。

## データ要件
- ユーザーエンティティ：`id`、`email`、`displayName`、`role`、`status`、`lastLoginAt`、`createdAt`。
- エラーログ：`id`、`level`、`message`、`context`、`occurredAt`。
- モデル情報：`modelId`、`version`、`createdAt`、`metrics`、`status`。
- 監査ログ：`id`、`actor`、`action`、`resource`、`timestamp`、`details`。

## 状態と遷移
- 初期：管理者権限を確認後、各タブデータを遅延ロード。
- 操作成功：ステータストースト表示、該当テーブルを再フェッチ。
- 操作失敗：APIエラー内容を表示、認可エラー403時は再ログインを促す。
- モデル再学習：実行後は進行状況ポーリング、完了時に結果ダイアログ表示。

## インタラクション
- ユーザー凍結/解除：確認ダイアログ、理由入力（任意）を追加、監査ログに記録。
- 権限変更：ドロップダウンでロール選択、保存後に即時反映。
- エラーログ：詳細展開でスタックトレース閲覧、フィルタで重大度ごとに絞り込み。
- モデル再学習：モデル選択→再学習パラメータ（任意）入力→実行、結果通知。
- 監査ログ：CSVエクスポート、重大アクションは固定表示。

## バリデーション・エラーハンドリング
- 管理操作はCSRF対策と二重送信防止を実装。
- モデル再学習リクエストは同一バージョンへの重複実行を防ぐ。
- APIエラー（429/500）はリトライ案内、権限エラーは即時ログアウトも検討。

## 計測・ログ
- 管理操作はすべて監査ログに記録され、UI側では主要イベントのみ計測（`admin_user_updated`など）。
- エラーログ閲覧数や再学習実行回数を分析用に収集。
- 失敗操作はSentryに送信し、運用チームへ通知。

## アクセシビリティ
- 大量データテーブルはキーボードで操作可能にし、行選択時のフォーカスを明示。
- 状態アイコンはテキストと併用し、色覚依存を排除。
- モーダルは`dialog`ロールとフォーカストラップを適切に管理。

## テスト観点
- 単体：権限チェック、状態更新ロジック、ポーリング制御。
- 統合：APIモックでユーザー更新、モデル再学習トリガ、監査ログ取得。
- E2E：管理者ログイン→ユーザー権限変更→ジョブ再実行→監査ログ確認のシナリオ。

## 未決定事項・メモ
- モデル再学習のパラメータ編集範囲（例：期間指定、特徴量セット）。
- 監査ログの保持期間とエクスポート上限。
- エラーログの外部連携（例：Sentryリンク）をUIに表示するか。

