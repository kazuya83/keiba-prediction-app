# 通知ページ 仕様

## 概要
- 予測完了やレース結果確定、システムアラートなどを一覧表示し、既読管理と設定変更を行う画面。
- アプリ内通知を中心とし、ブラウザプッシュを利用する場合は登録状態を表示する。

## ペルソナとユースケース
- 一般ユーザー：直近の予測完了・結果を確認し、次のアクションへ移る。
- 上級ユーザー：重要なモデル更新やエラー通知を追跡。
- 管理者：バッチ処理の成功/失敗を確認。

## 前提・依存
- API：`GET /api/notifications`、`PUT /api/notifications/{notification_id}/read`、`POST /api/notifications/settings`（計画10）。
- 通知生成はバックエンドのバッチ・推論処理からトリガーされる。
- Web Pushを利用する場合はVAPIDキー登録状態を取得するAPIが必要。

## UI構成
- 未読/既読タブ切替。
- 通知リスト：タイトル、カテゴリ（予測/結果/アラート）、詳細メッセージ、作成日時、アクションボタン（例：予測結果を見る）。
- バルク操作：全て既読、選択して既読、削除（ソフトデリート）。
- 通知設定パネル：カテゴリ別通知ON/OFF、ブラウザプッシュ許可状態、通知時刻帯設定。
- ステータスバナー：ブラウザプッシュ未許可の場合の案内。

## データ要件
- 通知エンティティ：`id`、`type`、`title`、`body`、`createdAt`、`read`、`actionUrl`、`metadata`（raceId等）。
- 設定エンティティ：`enableApp`、`enablePush`、`preferredRaces[]`、`quietHours`。
- APIはページネーション対応、未読件数をレスポンスヘッダまたは別APIで返却。

## 状態と遷移
- 初期：未読タブを表示、ローディングスケルトン。
- 既読処理：即時UI更新し、バックエンドの結果に同期。失敗時はロールバック。
- バルク操作：確認ダイアログ後に実行、進行状況をトーストで通知。
- 通知クリック：`actionUrl`があれば該当ページへ遷移し、既読化を自動実行。
- 設定更新：`POST /settings`成功時にトースト表示、同期失敗時はエラー表示。

## インタラクション
- 無限スクロールまたは「もっと読む」で過去通知を取得。
- カテゴリフィルタ（予測/結果/システム）を追加可能。
- ブラウザ通知許可ボタンでPush APIを呼び出し、拒否時は再許可案内を表示。

## バリデーション・エラーハンドリング
- 設定更新でQuiet Hoursの開始・終了時刻整合性をチェック。
- Push登録失敗時は詳細メッセージと再試行手順を表示。
- APIエラーは通知ごとに部分的リトライを実装し、全体失敗時はバナー表示。

## 計測・ログ
- `notifications_viewed`イベントでタブとフィルタ状況を計測。
- 既読操作、設定変更、Push許可率をトラッキング。
- 重大通知が未読のまま一定時間経過した場合、バックエンドで再通知する仕組みを検討。

## アクセシビリティ
- 通知アイテムにはARIAロール`listitem`を付与、状態変化をライブリージョンで読み上げ。
- 操作ボタンはキーボードアクセス可能にし、フォーカスインジケータを明確にする。
- 色覚に依存せずカテゴリを識別できるよう、アイコンとテキストで表現。

## テスト観点
- 単体：既読状態管理、設定フォームバリデーション、Push登録処理。
- 統合：APIモックで未読→既読遷移、設定保存、エラー時のロールバック。
- E2E：通知閲覧→詳細ページ遷移→戻る→設定変更の一連操作。

## 未決定事項・メモ
- 通知の保存期間と削除方針（例：90日で自動アーカイブ）。
- ブラウザプッシュ実装の有無と対象ブラウザ。
- 重大通知の固定表示（ピン留め）機能を追加するか。

